# å¾®èª¿ (Finetune) Whisper æ¨¡å‹
## åŸºæœ¬è³‡è¨Š
+ æ¨¡å‹
	+ ä¾†æº: https://huggingface.co/ADT109119/whisper-small-zh-TW
	+ åŠŸèƒ½: éŸ³è¨Šè½‰ç¹é«”ä¸­æ–‡
+ è¨“ç·´è³‡æ–™: 
	+ é »é“: [åƒåƒé€²é£Ÿä¸­](https://www.youtube.com/@Chienseating "åƒåƒé€²é£Ÿä¸­")
	+ å½±ç‰‡æ¸…å–®: [æ°´æ°´ä¾†å˜—é®®](https://www.youtube.com/playlist?list=PLWbKW1MoBjKLA2PuOwHL9AgO4yA-KIgRW "æ°´æ°´ä¾†å˜—é®®")
	+ è¨“ç·´è³‡æ–™å½±ç‰‡é€£çµ: [ã€åƒåƒé€²é£Ÿä¸­ã€‘é¥—é¥—å…¨å“é …æ”»ç•¥ï¼é«˜æ¨“æ™¯è§€åƒåˆ°é£½ï¼æ€éº¼åƒæ¯”è¼ƒå¥½ï¼Ÿï¼](https://www.youtube.com/watch?v=HvugeIKJ9ok&list=PLWbKW1MoBjKLA2PuOwHL9AgO4yA-KIgRW&index=2&ab_channel=%E5%8D%83%E5%8D%83%E9%80%B2%E9%A3%9F%E4%B8%AD "ã€åƒåƒé€²é£Ÿä¸­ã€‘é¥—é¥—å…¨å“é …æ”»ç•¥ï¼é«˜æ¨“æ™¯è§€åƒåˆ°é£½ï¼æ€éº¼åƒæ¯”è¼ƒå¥½ï¼Ÿï¼")
+ é¡¯å¡: NVIDIA GeForce RTX 3070 Laptop GPU
```
NVIDIA-SMI 537.13
Driver Version: 537.13
CUDA Version: 12.2
```
+ ç’°å¢ƒç·¨è¼¯å™¨: Python IDLE 3.10.11 (is Python's Integrated Development and Learning Environment)
***

## å¤§ç¶±
#### [å‰ç½®æº–å‚™](#å‰ç½®æº–å‚™-1)
#### [ä¸‹è¼‰æ¨¡å‹](#ä¸‹è¼‰æ¨¡å‹-1)
#### [è³‡æ–™ä¸‹è¼‰èˆ‡é è™•ç†](#è³‡æ–™ä¸‹è¼‰èˆ‡é è™•ç†-1)
#### [çµèª](#çµèª-1)
***

## å‰ç½®æº–å‚™

* #### å¥—ä»¶å®‰è£
  å°æ–¼åˆä¾†ä¹åˆ°çš„è®€è€…ï¼Œç‚ºäº†ç¶­æŒä½ æƒ³å¯¦ä½œçš„**è€å¿ƒç±Œç¢¼**ï¼Œå°‡ç›¸é—œçš„å¥—ä»¶å…ˆè¡Œå®‰è£å¥½ï¼Œå¯ä»¥æ¸›å°‘å¾ˆå¤šä¸å¿…è¦çš„è¡ä¼¸å ±éŒ¯ï¼Œé€ æˆç±Œç¢¼æå‰è€—æã€‚
  > å‡ºç¾é›£ä»¥è§£é–‹çš„å•é¡Œæ™‚ï¼Œä¹Ÿå¯ä»¥æ—©é»æ”¾æ£„ ? (èª¤

  ä½¿ç”¨ pip å®‰è£é€™äº›å¥—ä»¶ï¼Œæˆ–è€…ç›´æ¥å°‡ requirements.txt æ–‡ä»¶æ‰“é–‹ç›´æ¥é€ä¸€å¥—ä»¶è¤‡è£½å‡ºä¾†ï¼Œå†è‡ªè¡Œå®‰è£ä¹Ÿè¡Œï¼Œä¹Ÿå¯ä»¥ç…§å¦‚ä¸‹æ­¥é©Ÿä¸€æ¬¡å®‰è£ï¼š
  1. æ‰“é–‹å‘½ä»¤æç¤ºå­—å…ƒã€‚
  
  2. ä½¿ç”¨ cd å‘½ä»¤ä¾†åˆ‡æ›ç›®éŒ„ï¼Œåˆ°å­˜æ”¾ requirements.txt æ–‡ä»¶çš„ç›®éŒ„ã€‚
  3. åœ¨ç›®éŒ„ä¸­åŸ·è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£å¥—ä»¶ï¼š
  
  ```
  pip install -r requirements.txt
  ```

  æˆ–è€…
  
  2. è¤‡è£½ requirements.txt æ–‡ä»¶çš„è·¯å¾‘ã€‚
  3. åœ¨ç›®éŒ„ä¸­åŸ·è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£å¥—ä»¶ï¼š
  
  ```
  pip install -r æ–‡ä»¶çš„è·¯å¾‘
  ```

***
* #### CUDA
  ä¾æ“šç¾åœ¨ç•¶ä¸‹çš„æ™‚æœŸï¼Œå°šæœªæœ‰è©²ç¡¬é«”é…ç½®çš„ç›¸æ‡‰ cuda ç©©å®šçš„ç‰ˆæœ¬ã€‚ä½œè€…ç•¶æ™‚è‡†æ¸¬æš¨å¯¦éš›æ¸¬è©¦:
  + æ˜¯å¦æœ‰å‘å‰ç‰ˆæœ¬ç›¸å®¹ ? => ä¸
  + æ˜¯å¦æ˜¯ä¸‹è¼‰çš„ Nvidia CUDA toolkit çš„å“ªå€‹å…ƒä»¶æ¼è£ ? => ä¸
  + æ˜¯å¦æ˜¯ä¸‹è¼‰çš„ Nvidia CUDA toolkit çš„å…ƒä»¶å…¨è£ ? => ä¸
  + æ˜¯å¦æ˜¯ä¸‹è¼‰çš„ Nvidia CUDA toolkit ï¼Œè¦ç”¨è‡ªè¨‚ç¾©å®‰è£ ? => ä¸
  + cudnn æ²’å®‰è£ ? => ä¸

  ... ...ç­‰ç­‰è«¸å¤šå•é¡Œ

  æœ€å¾Œåˆ ~~ å›å†åº¦åˆ° [PyTorch å®˜ç¶²](https://pytorch.org/get-started/locally/#start-locally)ï¼Œå¦‚ä¸‹é»é¸:
  ```
  PyTorch Build => Preview (Nightly)
  Your OS => Windows
  Package => Pip
  Language => Python
  Compute Platform => CUDA 12.1
  ```

  å¾—åˆ° Run this Command
  > pip3 install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cu121

**å˜€å’•: å‰å‰å¾Œå¾Œæ‹†è£ CUDA toolkit å’Œ cudnn æ•¸æ¬¡ï¼Œçµæœæœ€å¾Œæ ¹æœ¬å®Œå…¨æ²’å®‰è£...**

***
* #### FFmpeg
  ä¸€å€‹å…è²»çš„é–‹æºè»Ÿé«”åº«ï¼Œè™•ç†å’Œæ“ä½œéŸ³è¨Šå’Œå½±ç‰‡ã€‚å¸¸è¢«å»£æ³›ç”¨æ–¼å„ç¨®ç›®çš„ï¼ŒåŒ…æ‹¬è½‰ç¢¼ã€åŸºæœ¬ç·¨è¼¯ä»¥åŠéæ¿¾å’Œ Stream å‚³è¼¸ç­‰ä»»å‹™ã€‚

  1. å®˜ç¶²ä¸‹è¼‰: [Download FFmpeg](https://ffmpeg.org/download.html "FFmpeg")
  2. è§£å£“ç¸®æª”æ¡ˆï¼Œæ”¾ç½®çš„ä½ç½®ä¸èƒ½å¤ªéš¨ä¾¿ï¼Œè¦ç©©å®šä¸”ä¸æœƒè¢«"è«åå…¶å¦™æ¬èµ°"çš„
  3. **è¨­å®šç’°å¢ƒè®Šæ•¸**
  4. æ¸¬è©¦ï¼Œåœ¨å‘½ä»¤æç¤ºå­—å…ƒè¼¸å…¥
  
  ```
  ffmpeg
  ```
  
  æœƒæ´‹æ´‹ç‘ç‘çš„å‡ºç¾ ffmpeg èªªæ˜ï¼Œåæ­£æ²’å ±éŒ¯å°±è¡Œ
***

## ä¸‹è¼‰æ¨¡å‹
æ¨¡å‹å–è‡ª [Hugging Face](https://huggingface.co/ "Hugging Face")ï¼ŒåŸºæœ¬ä¸Šï¼Œ**å„å¼å„æ¨£å„ç¨®é¡çš„æ¨¡å‹ æ‡‰è©² éƒ½æ‰¾çš„åˆ°**ï¼Œåªè¦ä½ é›»è…¦ hold çš„ä½ã€è£å¾—ä¸‹ (æ¨¡å‹é™¤éæœ‰å‡ºè¼ƒå°çš„"å°ºå¯¸"ï¼Œä»–å€‘é€šå¸¸æœ‰åˆ¥ç¨±å’Œå»¶ä¼¸å‘½åï¼Œå¦å‰‡å¤§éƒ¨åˆ†å¹¾ **"G"** è·‘ä¸æ‰ï¼Œé€™é‚„æ²’æœ‰è€ƒæ…®é€²é–‹å§‹ä½¿ç”¨æˆ–è¨“ç·´æ™‚éœ€è¦çš„å¤§é‡è¨˜æ†¶é«”)ï¼ŒèŠ±é»æ™‚é–“ä¸‹è¼‰æ¨¡å‹ä¸‹ä¾†é«”é©—ä¹Ÿæœƒæœ‰ä¸éŒ¯çš„æ¢ç´¢é«”é©—ã€‚

å¦å¤–ï¼Œè‹¥æ˜¯çœŸçš„è·Ÿæˆ‘ç”¨ç›¸åŒçš„ç’°å¢ƒç·¨è¼¯å™¨ï¼Œåˆ¥ä¾è³´ç¨‹å¼è£¡å¼•å…¥å¥—ä»¶ç›´æ¥ä¸‹è¼‰ï¼Œä½œè€…å€‹äººç¶“é©—ï¼Œé‚£å€‹é€Ÿåº¦**çœŸ~~çš„å ªæ†‚**åˆ°æ‡·ç–‘äººç”Ÿã€‚
> ä½œè€…æœ‰ç•™æ„åˆ°ï¼Œä¸‹è¼‰é€Ÿåº¦ä¼¼ä¹æœƒ**éš¨è‘—å®Œæˆä¸‹è¼‰é‡å¢åŠ è€Œé™é€Ÿ**ï¼ŒåŸå› ä¸æ˜

é‚£æ€éº¼è¾¦ ? å°ï¼Œå…ˆé€éå…¶ä»–ç®¡é“ä¸‹è¼‰ï¼Œå¦‚å‘½ä»¤æç¤ºå­—å…ƒ:
```
transformers-cli download your_model_name
```

å…¶ä¸­ï¼Œyour_model_name å°±æ˜¯åœ¨é é¢è£¡ï¼Œåç¨±æ—æœ‰å€‹æ˜é¡¯çš„è¤‡è£½æŒ‰éˆ•ï¼ŒæŒ‰ä¸‹å¾Œå¾—åˆ°çš„è¤‡è£½å…§å®¹ (æ ¼å¼å¤§æ¦‚åƒ "ADT109119/whisper-small-zh-TW")ã€‚

è‡³æ–¼ä¸‹è¼‰çš„æ±è¥¿åˆ°å“ªå»äº†å‘¢ ? 

é€šå¸¸ä½æ–¼ä½¿ç”¨è€…ä¸»ç›®éŒ„ä¸‹çš„ .cache æ–‡ä»¶å¤¾ä¸­ï¼Œ

è·¯å¾‘
Linux å’Œ macOS
```
~/.cache/huggingface/hub
```

æˆ–

Windows
```
C:\Users\YourUsername\\.cache\huggingface\hub
```

æ”¾ç½®æ›¾ç¶“æ¡ç”¨é è¨­è·¯å¾‘ä¸‹è¼‰çš„å„å¼æ¨¡å‹ï¼Œè³‡æ–™å¤¾åç¨±åŒè¤‡è£½å…§å®¹ã€‚
***

## è³‡æ–™ä¸‹è¼‰èˆ‡é è™•ç†
* #### è³‡æ–™
  å¾®èª¿ (Finetnue) é¸ç”¨çš„è¨“ç·´è³‡æ–™ï¼Œå– [Youtube CC æˆæ¬Š](https://www.youtube.com/t/creative_commons "
å‰µç”¨ CC å§“åæ¨™ç¤ºæˆæ¬Š (å…è¨±å†åˆ©ç”¨)")çš„å½±ç‰‡ç‚ºç´ æã€‚è¨­å®šæ¢ä»¶ç¯©é¸å¾Œï¼Œæ»‘å‘€æ»‘å‘€æ»‘ï½ï¼Œæ„å¤–åœ¨[åƒåƒé€²é£Ÿä¸­](https://www.youtube.com/@Chienseating "åƒåƒé€²é£Ÿä¸­")ä¸­ç™¼ç¾é »é“æœ‰ CC æˆæ¬Šçš„å½±ç‰‡ï¼Œå°±æ˜¯å®ƒå•¦ï¼

  > å°æé†’ï¼Œåˆæ¬¡å˜—è©¦çš„æ–°æ‰‹ï¼Œé¸ç”¨ç´ ææ™‚ï¼Œæœ€å¥½æ˜¯å°‹æ‰¾å£é½’æ¸…æ™°ã€æœ‰å­—å¹•æä¾›ä¸‹è¼‰ï¼Œé€²ä¸€æ­¥æŒ‘æˆ°çš„ï¼Œå¯ä»¥è€ƒæ…®ç‰¹å®šä¸»é¡Œï¼Œæœƒæœ‰è¼ƒå¤šå°ˆæ¥­è¡“èªï¼ŒåŒæ™‚ä¹Ÿæœƒé¢è‡¨å¤šèªè¨€è¡“èªçš„æŒ‘æˆ°ã€‚
***

* #### ä¸‹è¼‰
  éç¨‹å¤§é‹¼:
  1. å–å¾—å½±ç‰‡è³‡è¨Šã€‚
  2. æª¢æŸ¥æ˜¯å¦æ›¾ä¸‹è¼‰éã€‚
  3. è‹¥ç„¡ï¼Œå‰‡ä¸‹è¼‰æˆ "mp4" æ ¼å¼ã€‚åä¹‹å‰‡ä¸åšäº‹ã€‚
  4. éç¨‹ä¸­è‹¥ç™¼ç”ŸéŒ¯èª¤è¨Šæ¯ï¼Œäº¦å¯«å…¥ç´€éŒ„æª”ä¾›äº‹å¾Œæª¢è¦–ã€‚

  é¡å¤–è¿½åŠ äº†å¯«å…¥ç´€éŒ„æª” log.txt çš„åŠŸèƒ½ï¼Œé™¤äº†å¯ä»¥å”åŠ©åˆ†æå„æ®µç¨‹å¼é‹ä½œæ‰“ç†æœ‰å•é¡Œä¹‹å¤–ï¼Œä¹ŸåŒæ™‚å¯ä»¥ä½œç‚ºä½¿ç”¨å›é¥‹èˆ‡ç´€éŒ„ ï¼

***

* #### é è™•ç†
  æ¥è‘—ï¼Œå¾—åˆ° **åŸå§‹ç´ æ** å¾Œï¼Œè¦é€²è¡Œä»¥ä¸‹æµç¨‹:
  1. è¼‰å…¥èªéŸ³è¾¨è­˜æ¨¡å‹
  2. é€é ffmpeg è½‰æª”æˆ "wav"
  3. é€é ffmpeg é‡æ–°å–æ¨£
  4. é€é ffmpeg è£åˆ‡æˆ 10 ç§’ä¸€æ®µï¼Œç›¸é„°å…©æ®µé ­å°¾å½¼æ­¤é‡ç–Š 2 ç§’
  5. è¼¸å…¥æ¨¡å‹é€²è¡Œè¾¨è­˜ï¼Œ
  6. å°‡éŸ³è¨Šæª”è·¯å¾‘èˆ‡è¾¨è­˜çµæœå¯«å…¥è³‡æ–™æª”

  ä¹Ÿæœ‰å¯«å…¥ç´€éŒ„æª” log.txt çš„åŠŸèƒ½
***

> æœ‰é—œé€²ä¸€æ­¥çš„è³‡æ–™é è™•ç†éç¨‹ï¼Œå¯ä»¥åƒè€ƒæœ¬å°ˆæ¡ˆè³‡æ–™å¤¾ "finetume-wav2text" ä¸‹çš„  "[README.md](https://github.com/Li732375/Finetune_Whisper_audio2zh/tree/master/finetume-wav2text#%E5%A6%82%E4%BD%95%E7%94%A2%E7%94%9F%E8%87%AA%E5%B7%B1%E7%9A%84%E9%9F%B3%E8%A8%8A%E8%B3%87%E6%96%99%E9%9B%86 "å¦‚ä½•ç”¢ç”Ÿè‡ªå·±çš„éŸ³è¨Šè³‡æ–™é›†")"

***

## çµèª
æ¥ä¸‹ä¾†**è¨“ç·´æ¨¡å‹**çš„æµç¨‹éƒ½åƒç…§ [Hugging Face](https://huggingface.co/ "Hugging Face") å®˜ç¶²çš„èª²ç¨‹æ•™å­¸ï¼Œç¶²è·¯ä¸Šä¹Ÿæœ‰è«¸å¤šç›¸åŒç¨‹å¼ç¢¼ä½†å…¶ä»–èªè¨€ (é€™è£¡æŒ‡å¦‚å°åœ°å®‰èªç­‰äººé¡èªè¨€ï¼Œéç¨‹å¼èªè¨€)çš„ç‰ˆæœ¬ï¼Œè®€è€…å¯ä»¥å†è‡ªè¡Œåƒç…§ä¿®æ”¹ã€‚

> å°æ–¼å˜—è©¦å°ˆæ¡ˆçš„æ–°æ‰‹**å¹¾ä¹æ²’æœ‰å¤ªå¤šç‚ºäº†é…åˆè³‡æ–™ä¸»é¡Œè€Œéœ€è¦ç•°å‹•çš„å»¶ä¼¸éœ€æ±‚**ï¼Œæ’é™¤ç¡¬é«”é™åˆ¶ï¼Œå…¶å¯¦ç›¸ç•¶æ¨è–¦!!

èª²ç¨‹é€£çµ: [How to fine-tune an ASR system with the Trainer API](https://huggingface.co/learn/audio-course/chapter5/fine-tuning "How to fine-tune an ASR system with the Trainer API")

æœ‰è¦é€²ä¸€æ­¥ç†è§£ç›¸é—œå»¶ä¼¸å…§å®¹ (åƒæ˜¯å°æ–¼éŸ³è¨Šç›¸é—œã€å…¶ä»–éŸ³è¨Šæ¨¡å‹å¾®èª¿å’Œå…¶ä»–åŠŸèƒ½çš„æ¨¡å‹)ï¼Œä¹Ÿå¯ä»¥å‰å¾€æ¢ç´¢ ï¼ï¼
***

è¨“ç·´å®Œæˆï¼Œæ“·å–æœ«ç«¯è¨Šæ¯
```
...ä»¥ä¸Šç•¥...
{'loss': 0.0008, 'learning_rate': 1e-05, 'epoch': 55.56}

100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 500/500 [6:17:32<00:00, 47.08s/it]

  0%|          | 0/5 [00:00<?, ?it/s][A

 40%|â–ˆâ–ˆâ–ˆâ–ˆ      | 2/5 [00:27<00:40, 13.57s/it][A

 60%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    | 3/5 [00:56<00:40, 20.26s/it][A

 80%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  | 4/5 [01:23<00:22, 22.67s/it][A

100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [01:26<00:00, 15.67s/it][A
                                                   


                                             
[A{'eval_loss': 0.47434207797050476, 'eval_wer_ortho': 89.47368421052632, 'eval_wer': 88.54166666666666, 'eval_runtime': 119.4007, 'eval_samples_per_second': 0.57, 'eval_steps_per_second': 0.042, 'epoch': 55.56}

100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 500/500 [6:19:31<00:00, 47.08s/it]

100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [01:28<00:00, 15.67s/it][A




[A{'train_runtime': 22783.6424, 'train_samples_per_second': 0.351, 'train_steps_per_second': 0.022, 'train_loss': 0.056482920687645675, 'epoch': 55.56}

100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 500/500 [6:19:43<00:00, 47.08s/it]
100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 500/500 [6:19:43<00:00, 45.57s/it]
...ä»¥ä¸‹ç•¥...
```

è¨“ç·´å®Œæœƒç”¢ç”Ÿè³‡æ–™å¤¾ "finetune-whisper-small"ï¼Œç„¶è€ŒåŸºæ–¼å–®æª” 100M é™åˆ¶ï¼Œåªèƒ½åˆ†å‰²ä¸Šå‚³ï¼Œè¨˜å¾—è§£å£“ç¸®å–”~~

å˜€å’•: è‹¥ç¡¬é«”é™åˆ¶ç•¥ä½çš„ (å°±æ˜¯è·‘ä¸‹å»ä¸æœƒç•¶æ©Ÿï¼Œç°¡å–®ä½¿ç”¨ç€è¦½å™¨è·Ÿæ–‡æ›¸ä¸æœƒå¡çš„)ï¼Œè¦ºå¾—é è¨­é…ç½®é‚„æœƒè·‘ä¸Šåƒç™¾å¹´çš„ï¼Œæ”¹ä¸€ä¸‹é…ç½®

> training_args = Seq2SeqTrainingArguments é€™è£¡ï¼Œper_device_train_batch_size = 8ã€gradient_accumulation_steps = 2
> åˆ¥æ‡·ç–‘ï¼Œå…ˆé™é–€æª»å†èªª...ä¸ç„¶å°±æœƒåƒè³‡æ–™å¤¾ "finetume-wav2text" ä¸‹çš„ log.txt çš„ç´€éŒ„ä¸€æ¨£æ…˜ï¼Œå“­ ~ å•Š ï¼

> å¦å‰‡é è¨­å°±ç›´æ¥ per_device_train_batch_size = 4ã€gradient_accumulation_steps = 4ï¼Œåˆ¥é€å¼· !



***

åƒè€ƒé€£çµ
+ è‹±ï¼Œ[Create an audio dataset](https://huggingface.co/docs/datasets/audio_dataset)
+ è‹±ï¼Œ[Fine-tuning the ASR model](https://huggingface.co/learn/audio-course/chapter5/fine-tuning#finetuning-the-asr-model)
+ è‹±ï¼Œ[Introduction to audio data](https://huggingface.co/learn/audio-course/chapter1/audio_data)
+ è‹±ï¼Œ[Load Dataset](https://huggingface.co/learn/audio-course/chapter5/fine-tuning#load-dataset)
+ è‹±ï¼Œ[Load audio data](https://huggingface.co/docs/datasets/audio_load#load-audio-data)

